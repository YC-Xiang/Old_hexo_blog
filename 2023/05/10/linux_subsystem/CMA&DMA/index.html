

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Yucheng Xiang">
  <meta name="keywords" content="">
  
    <meta name="description" content="Reserved-memory参考：http:&#x2F;&#x2F;www.wowotech.net&#x2F;memory_management&#x2F;cma.html https:&#x2F;&#x2F;xilinx-wiki.atlassian.net&#x2F;wiki&#x2F;spaces&#x2F;A&#x2F;pages&#x2F;18841683&#x2F;Linux+Reserved+Memory?view&#x3D;blog &#x2F;Documentation&#x2F;devicetree&amp;">
<meta property="og:type" content="article">
<meta property="og:title" content="CMA&amp;DMA">
<meta property="og:url" content="https://yc-xiang.github.io/2023/05/10/linux_subsystem/CMA&DMA/index.html">
<meta property="og:site_name" content="Yucheng&#39;s Blog">
<meta property="og:description" content="Reserved-memory参考：http:&#x2F;&#x2F;www.wowotech.net&#x2F;memory_management&#x2F;cma.html https:&#x2F;&#x2F;xilinx-wiki.atlassian.net&#x2F;wiki&#x2F;spaces&#x2F;A&#x2F;pages&#x2F;18841683&#x2F;Linux+Reserved+Memory?view&#x3D;blog &#x2F;Documentation&#x2F;devicetree&amp;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://xyc-1316422823.cos.ap-shanghai.myqcloud.com/20230510112218.png">
<meta property="article:published_time" content="2023-05-10T09:40:28.000Z">
<meta property="article:modified_time" content="2023-08-02T06:30:33.087Z">
<meta property="article:author" content="Yucheng Xiang">
<meta property="article:tag" content="Linux">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://xyc-1316422823.cos.ap-shanghai.myqcloud.com/20230510112218.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>CMA&amp;DMA - Yucheng&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"yc-xiang.github.io","root":"/","version":"1.9.4","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"C"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"ed5b2440a3a7651272e4681ae4ac17e2","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  
    <!-- Baidu Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?ed5b2440a3a7651272e4681ae4ac17e2";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  

  

  

  

  

  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>YC&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/homepage.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">CMA&DMA</span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-05-10 17:40" pubdate>
          2023年5月10日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          6.2k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          52 mins
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> times
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">CMA&amp;DMA</h1>
            
              <p class="note note-info">
                
                  
                    本文最后更新于：2023年8月2日 下午
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <h1 id="Reserved-memory"><a href="#Reserved-memory" class="headerlink" title="Reserved-memory"></a>Reserved-memory</h1><p>参考：<a target="_blank" rel="noopener" href="http://www.wowotech.net/memory_management/cma.html">http://www.wowotech.net/memory_management/cma.html</a></p>
<p><a target="_blank" rel="noopener" href="https://xilinx-wiki.atlassian.net/wiki/spaces/A/pages/18841683/Linux+Reserved+Memory?view=blog">https://xilinx-wiki.atlassian.net/wiki/spaces/A/pages/18841683/Linux+Reserved+Memory?view=blog</a></p>
<p>&#x2F;Documentation&#x2F;devicetree&#x2F;bindings&#x2F;reserved-memory&#x2F;reserved-memory.txt</p>
<p>定义了no-map属性的，不会自动映射到虚拟地址，需要自行在driver中映射。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// dts</span><br>reserved: buffer@<span class="hljs-number">0x38000000</span> &#123;<br>    no-<span class="hljs-built_in">map</span>;<br>    reg = &lt;<span class="hljs-number">0x38000000</span> <span class="hljs-number">0x08000000</span>&gt;;<br>&#125;;<br><br><span class="hljs-comment">/* Get reserved memory region from Device-tree */</span><br>np = of_parse_phandle(dev-&gt;of_node, <span class="hljs-string">&quot;memory-region&quot;</span>, <span class="hljs-number">0</span>);<br><br>rc = of_address_to_resource(np, <span class="hljs-number">0</span>, &amp;r);<br><br>lp-&gt;paddr = r.start;<br>lp-&gt;vaddr = memremap(r.start, resource_size(&amp;r), MEMREMAP_WB);<br></code></pre></td></tr></table></figure>



<p>定义”shared-dma-pool” 就可以创建DMA memory pool，使用DMA engine API了。of_reserved_mem_device_init中会帮我们创建映射。（DMA在of_reserved_mem_device_init阶段会进行memremap同上，这个remap不是直接映射的方式）。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// dts</span><br>reserved: buffer@<span class="hljs-number">0</span> &#123;<br>  compatible = <span class="hljs-string">&quot;shared-dma-pool&quot;</span>;<br>  no-<span class="hljs-built_in">map</span>;<br>  reg = &lt;<span class="hljs-number">0x0</span> <span class="hljs-number">0x70000000</span> <span class="hljs-number">0x0</span> <span class="hljs-number">0x10000000</span>&gt;;<br>&#125;;<br><br><span class="hljs-comment">/* Initialize reserved memory resources */</span><br>rc = of_reserved_mem_device_init(dev);<br><br><span class="hljs-comment">/* Allocate memory */</span><br>dma_set_coherent_mask(dev, <span class="hljs-number">0xFFFFFFFF</span>);<br>lp-&gt;vaddr = dma_alloc_coherent(dev, ALLOC_SIZE, &amp;lp-&gt;paddr, GFP_KERNEL);<br></code></pre></td></tr></table></figure>

<p>log:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[    0.000000] Reserved memory: created DMA memory pool at 0x0000000070000000, size 256 MiB<br>[    0.000000] Reserved memory: initialized node buffer@0, compatible id shared-dma-pool<br></code></pre></td></tr></table></figure>



<p>加上resuable属性，变成CMA pool。（CMA在dma_alloc_coherent时会通过__va宏返回直接映射的虚拟地址）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">reserved: buffer@<span class="hljs-number">0</span> &#123;<br>  compatible = <span class="hljs-string">&quot;shared-dma-pool&quot;</span>;<br>  reusable;<br>  reg = &lt;<span class="hljs-number">0x0</span> <span class="hljs-number">0x70000000</span> <span class="hljs-number">0x0</span> <span class="hljs-number">0x10000000</span>&gt;;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>log：</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mel">[    <span class="hljs-number">0.000000</span>] Reserved <span class="hljs-keyword">memory</span>: created CMA <span class="hljs-keyword">memory</span> pool at <span class="hljs-number">0x0000000070000000</span>, <span class="hljs-keyword">size</span> <span class="hljs-number">256</span> MiB<br>[    <span class="hljs-number">0.000000</span>] Reserved <span class="hljs-keyword">memory</span>: initialized node buffer@0, compatible id shared-dma-pool<br></code></pre></td></tr></table></figure>



<p><strong>DMA pool是driver独有的，CMA pool在driver不使用的时候会被共享。</strong></p>
<h1 id="Dynamic-DMA-mapping-Guide"><a href="#Dynamic-DMA-mapping-Guide" class="headerlink" title="Dynamic DMA mapping Guide"></a>Dynamic DMA mapping Guide</h1><p><a target="_blank" rel="noopener" href="https://docs.kernel.org/core-api/dma-api-howto.html">https://docs.kernel.org/core-api/dma-api-howto.html</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/109919756">https://zhuanlan.zhihu.com/p/109919756</a></p>
<h2 id="CPU-and-DMA-addresses"><a href="#CPU-and-DMA-addresses" class="headerlink" title="CPU and DMA addresses"></a>CPU and DMA addresses</h2><p><img src="https://xyc-1316422823.cos.ap-shanghai.myqcloud.com/20230510112218.png" srcset="/img/loading.gif" lazyload></p>
<p>有IOMMU的设备，设备device访问的地址是bus address（等同于dma address），IOMMU负责CPU physical address和bus address的映射。</p>
<p>嵌入式设备一般没有IOMMU，此时bus address&#x3D;CPU pyhsical address。设备直接访问cpu的物理地址。</p>
<h2 id="What-memory-is-DMA’able"><a href="#What-memory-is-DMA’able" class="headerlink" title="What memory is DMA’able?"></a>What memory is DMA’able?</h2><p><code>__get_free_page*()</code>, <code>kmalloc()</code>, <code>kmem_cache_alloc()</code>这些分配连续空间地址的都可以dma mapping。</p>
<p><code>vmalloc()</code>, <code>kmap()</code>不行。</p>
<h2 id="DMA-addressing-capabilities"><a href="#DMA-addressing-capabilities" class="headerlink" title="DMA addressing capabilities"></a>DMA addressing capabilities</h2><p>设置设备通过DMA能驱动多少位地址，寻址能力。</p>
<p>同时设置streaming和coherent mapping：</p>
<p><code>int dma_set_mask_and_coherent(struct device *dev, u64 mask)</code></p>
<p>只设置streaming mapping：</p>
<p><code>int dma_set_mask(struct device *dev, u64 mask);</code></p>
<p>只设置coherent mapping：</p>
<p><code>int dma_set_coherent_mask(struct device *dev, u64 mask);</code></p>
<h2 id="Types-of-DMA-mappings"><a href="#Types-of-DMA-mappings" class="headerlink" title="Types of DMA mappings"></a>Types of DMA mappings</h2><ul>
<li>一致性DMA映射（consistent DMA mappings）。driver初始化时map，shutdown时unmap。<ul>
<li>不需要考虑cache的影响，也就是说不需要软件进行cache操作，CPU和DMA controller都可以看到对方对DMA buffer的更新。CPU对memory的修改device可以立即感知到，反之亦然。</li>
<li>一致性的DMA映射并不意味着不需要memory barrier这样的工具来保证memory order。</li>
<li>在有些平台上，修改了DMA Consistent buffer后，你的驱动可能需要flush write buffer，以便让device侧感知到memory的变化。</li>
</ul>
</li>
<li>流式DMA映射（Streaming DMA mappings）。一次性的，需要进行DMA传输的时候map，DMA传输完成，就ummap。<code>spi-dw-rts.c</code>中ssi的传输就是流式dma映射。</li>
</ul>
<h2 id="一致性DMA映射"><a href="#一致性DMA映射" class="headerlink" title="一致性DMA映射"></a>一致性DMA映射</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">dma_addr_t</span> dma_handle;<br><span class="hljs-comment">//cpu_addr:虚拟地址，dma_handle:总线地址，没有IOMMU相当于物理地址</span><br>cpu_addr = dma_alloc_coherent(dev, size, &amp;dma_handle, gfp);<br></code></pre></td></tr></table></figure>

<p>You may however need to make sure to flush the processor’s write buffers before telling devices to read that memory.见下方sync的API。</p>
<p>如果driver需要许多小的buffer,可以使用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dma_pool</span> *<span class="hljs-title">pool</span>;</span><br>pool = dma_pool_create(name, dev, size, align, boundary);<br>cpu_addr = dma_pool_alloc(pool, flags, &amp;dma_handle);<br></code></pre></td></tr></table></figure>

<h2 id="流式DMA映射"><a href="#流式DMA映射" class="headerlink" title="流式DMA映射"></a>流式DMA映射</h2><p>流式DMA映射需要设置DMA direction。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">DMA_BIDIRECTIONAL<br>DMA_TO_DEVICE<br>DMA_FROM_DEVICE<br>DMA_NONE<br></code></pre></td></tr></table></figure>

<p>接口一<code>dma_map_single</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device</span> *<span class="hljs-title">dev</span> =</span> &amp;my_dev-&gt;dev;<br><span class="hljs-type">dma_addr_t</span> dma_handle;<br><span class="hljs-type">void</span> *addr = buffer-&gt;ptr;<br><span class="hljs-type">size_t</span> size = buffer-&gt;len;<br><br>dma_handle = dma_map_single(dev, addr, size, direction);<br><span class="hljs-keyword">if</span> (dma_mapping_error(dev, dma_handle)) &#123;<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * reduce current DMA mapping usage,</span><br><span class="hljs-comment">         * delay and try again later or</span><br><span class="hljs-comment">         * reset driver.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">goto</span> map_error_handling;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接口二<code>dma_map_page</code></p>
<p>因为dma_map_single函数在进行DMA mapping的时候使用的是CPU指针（虚拟地址），导致该函数有一个弊端：不能使用HIGHMEM memory进行mapping。因为HIGHMEM memory没有进行线性映射，所以没有虚拟地址。</p>
<p>接口三<code>dma_map_sg</code></p>
<p>用于scatterlist情况，映射的对象是分散的若干段DMA buffer。具体不分析了。</p>
<h2 id="Sync"><a href="#Sync" class="headerlink" title="Sync"></a>Sync</h2><p>如果你需要多次访问同一个streaming DMA buffer，并且在DMA传输之间读写DMA Buffer上的数据，这时候你需要小心进行DMA buffer的sync操作，以便CPU和设备（DMA controller）可以看到最新的、正确的数据。</p>
<p><code>dma_sync_single_for_cpu(dev, dma_handle, size, direction)</code></p>
<p>如果，CPU操作了DMA buffer的数据，然后你又想把控制权交给设备上的DMA控制器，让DMA controller访问DMA buffer，这时候，在真正让HW（指DMA控制器）去访问DMA buffer之前，需要：</p>
<p><code>dma_sync_single_for_device(dev, dma_handle, size, direction)</code></p>
<h1 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/wangyunqian6/article/details/6670110">https://blog.csdn.net/wangyunqian6/article/details/6670110</a></p>
<p>DMA是直接操作总线地址的，这里先当作物理地址来看待吧。如果cache缓存的内存区域不包括DMA分配到的区域，那么就没有一致性的问题。但是如果cache缓存包括了DMA目的地址的话，会出现什么什么问题呢？</p>
<p>问题出在，经过DMA操作，cache缓存对应的内存数据已经被修改了，而CPU本身不知道（DMA传输是不通过CPU的），它仍然认为cache中的数据就是内存中的数据，以后访问Cache映射的内存时，它仍然使用旧的Cache数据。这样就发生Cache与内存的数据“不一致性”错误。</p>
<p>顺便提一下，总线地址是从设备角度上看到的内存，物理地址是CPU的角度看到的未经过转换的内存（经过转换的是虚拟地址）</p>
<p>由上面可以看出，DMA如果使用cache，那么一定要考虑cache的一致性。解决DMA导致的一致性的方法最简单的就是禁止DMA目标地址范围内的cache功能。但是这样就会牺牲性能。</p>
<p>因此在DMA是否使用cache的问题上，可以根据DMA缓冲区期望保留的的时间长短来决策。DAM的映射就分为：<strong>一致性DMA映射</strong>和<strong>流式DMA映射</strong>。</p>
<p>因为LCD随时都在使用，因此在Frame buffer驱动中，使用一致性DMA映射上面的代码中用到 <strong>dma_alloc_wc</strong>（<strong>non-cache, buffered</strong>）函数，另外还有一个一致性DMA映射函数<strong>dma_alloc_coherent</strong>（<strong>non-cache，non-buffer</strong>）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">dma_alloc_coherent</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> device *dev, <span class="hljs-type">size_t</span> size,</span><br><span class="hljs-params">    <span class="hljs-type">dma_addr_t</span> *dma_handle, <span class="hljs-type">gfp_t</span> gfp)</span><br>&#123;<br>  <span class="hljs-keyword">return</span> dma_alloc_attrs(dev, size, dma_handle, gfp,<br>      (gfp &amp; __GFP_NOWARN) ? DMA_ATTR_NO_WARN : <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">dma_alloc_wc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> device *dev, <span class="hljs-type">size_t</span> size,</span><br><span class="hljs-params">         <span class="hljs-type">dma_addr_t</span> *dma_addr, <span class="hljs-type">gfp_t</span> gfp)</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> attrs = DMA_ATTR_WRITE_COMBINE;<br><br>  <span class="hljs-keyword">if</span> (gfp &amp; __GFP_NOWARN)<br>    attrs |= DMA_ATTR_NO_WARN;<br><br>  <span class="hljs-keyword">return</span> dma_alloc_attrs(dev, size, dma_addr, gfp, attrs);<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c">dma_alloc_attrs();<br>  dma_alloc_from_dev_coherent(); <span class="hljs-comment">// 如果dts有reserved memory会走这个函数</span><br>    dev_get_coherent_memory();<br>      <span class="hljs-keyword">return</span> dev-&gt;dma_mem <span class="hljs-comment">// 直接返回reserved-memory中分配的地址了</span><br>  <span class="hljs-keyword">return</span> cpu_addr;<br><br><span class="hljs-comment">// dev-&gt;mem的分配：</span><br>dma_init_reserved_memory();<br>  ops-&gt;device_init(dma_reserved_default_memory, <span class="hljs-literal">NULL</span>);<br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">reserved_mem_ops</span> <span class="hljs-title">rmem_dma_ops</span> =</span> &#123;<br>  .device_init	= rmem_dma_device_init,<br>&#125;;<br>rmem_dma_device_init();<br>  dma_init_coherent_memory();<br>  dma_assign_coherent_memory();<br>    dev-&gt;dma_mem = mem;<br><br></code></pre></td></tr></table></figure>

<p>看起来如果在dts中分配了reserved-memory，<code>dma_alloc_coherent</code>和<code>dma_alloc_wc</code>流程是一样的，都会走<code>dma_alloc_from_dev_coherent</code>从reserved-memory中分配空间（<strong>这块区域是cached？buffer？</strong>，rts3917启动中有打印：<code>Memory policy: Data cache writeback</code>是否与reserved memory有关系）</p>
<p><strong>所以rts_fb.c中有<code>dma_sync_single_for_device</code>?</strong></p>
<table>
<thead>
<tr>
<th>是否启用cache</th>
<th>是否启用 buffer</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>0</td>
<td>无cache，无写缓冲<br />读、写都直达外设硬件</td>
</tr>
<tr>
<td>0</td>
<td>1</td>
<td>无cache，有写缓冲<br />读操作直达外设硬件；写操作，CPU将数据写入到写缓冲后继续运行，由写缓冲进行写回操作。</td>
</tr>
<tr>
<td>1</td>
<td>0</td>
<td>有cache，写通模式write through。<br />数据要同时写入cache和内存，所以cache和内存中的数据保持一致。</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>有cache，写回模式write back<br />新数据只是写入cache ，不会立刻写入内存。</td>
</tr>
</tbody></table>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Notes/" class="category-chain-item">Notes</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Linux/">#Linux</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/05/12/linux_subsystem/GPIO/" title="GPIO Subsystem">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">GPIO Subsystem</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/05/10/linux_subsystem/Pinctrl/" title="Pinctrl Subsystem">
                        <span class="hidden-mobile">Pinctrl Subsystem</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>





  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
